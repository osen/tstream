<!DOCTYPE html>
<head>
  <title>TStream</title>

<script language="javascript" type="text/javascript" src="inkjet.min.js"></script>
<script language="javascript" type="text/javascript">

var currentImage;
var ctx;
var ws;

function on_recv()
{
  ws.send("idle");
}

function on_display(decoded)
{
  var imageData = ctx.getImageData(0, 0, decoded.width, decoded.height);
  var imageBytes = imageData.data;

  for(var i = 0, j = 0, size = decoded.width * decoded.height * 4; i < size;)
  {
    imageBytes[i++] = decoded.data[j++];
    imageBytes[i++] = decoded.data[j++];
    imageBytes[i++] = decoded.data[j++];
    imageBytes[i++] = decoded.data[j++];
  }

  ctx.putImageData(imageData, 0, 0);
}

window.onload = function() {

  var canvas = document.createElement("canvas");
  canvas.style.background = "gray";
  canvas.width = 800;
  canvas.height = 600;
  document.body.appendChild(canvas);
  ctx = canvas.getContext("2d");
  var image = new Image();

  //var decoder = new jpeg.lossless.Decoder();
  ws = new WebSocket('ws://' + location.host + '/ws');
  ws.binaryType = 'arraybuffer';
  //ws.binaryType = 'blob';

  if (!window.console) { window.console = { log: function() {} } };

  ws.onopen = function(ev)
  {
    ws.send("idle");
  };

  ws.onerror = function(ev) { console.log(ev); };
  ws.onclose = function(ev) { console.log(ev); };

  ws.onmessage = function(ev)
  {
/*
    alert("Received: " + ev.data.byteLength);
    var pixels = ev.data;
    var buffer = new Uint8Array(ev.data);
    //var output = decoder.decompress(buffer);
    var output = decoder.decompress(ev.data);
    alert("Output: " + output);
*/
    //var blob = new Blob([ev.data], {type: "image/jpeg"});
    //var url = (URL || webkitURL).createObjectURL(ev.data, {oneTimeOnly: true});

    inkjet.decode(ev.data, function(err, decoded)
    {
      if(err)
      {
        alert(err.message);
      }
      else
      {
        //alert("Width: " + decoded.width + " Height: " + decoded.height);
        on_display(decoded);
        window.requestAnimationFrame(on_recv);
      }
    });

  };

};
</script>
</head>
<body>
</body>
</html>

